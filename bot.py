import os
from datetime import datetime

from flask import Flask, request, abort

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage

app = Flask(__name__)

# ===== LINE TOKEN =====
CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")

line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)

# ===== ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á =====
TTS_LINK = "https://www.minimax.io/audio/text-to-speech"

# ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢ =====
THAI_MONTHS = [
    "", "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
    "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
    "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
]

def thai_date(d):
    year_th = d.year + 543
    return f"{d.day} {THAI_MONTHS[d.month]} {year_th}"

def build_outage_template(date_text):
    return (
        "üì¢ ‡∏á‡∏≤‡∏ô‡∏î‡∏±‡∏ö‡πÑ‡∏ü‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£\n\n"
        "üìÖ ‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ‡∏ó‡∏µ‡πà 12 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569\n"
        "‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤ 08:30 - 17:00 ‡∏ô.\n"
        "üìç ‡∏î‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ‡∏Ñ‡∏≠‡∏ï‡∏µ‡∏ô‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏£.‡∏£.‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ß‡πâ‡∏≤‡∏Å‡∏≠‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û ‡∏ñ‡∏∂‡∏á ‡∏õ‡∏≤‡∏Å‡∏ó‡∏≤‡∏á‡∏´‡∏ß‡πâ‡∏≤‡πÇ‡∏ó‡∏ô‡∏ñ‡∏ô‡∏ô‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°\n"
        "****************************************************\n"
        "üìÖ ‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 13 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569\n"
        "‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤ 08:30 - 17:00 ‡∏ô.\n"
        "üìç ‡∏î‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏ï‡∏∏‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á SF6 ‡πÑ‡∏£‡πà‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û\n"
        "*****************************************************\n"
        "üìÖ ‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 20 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569\n"
        "‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤ 08:30 - 17:00 ‡∏ô.\n"
        "üìç ‡∏î‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ‡∏™‡∏ß‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏™‡∏ß‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç ‡πÇ‡∏£‡∏á‡∏ô‡∏°‡∏™‡∏ß‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç ‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡πâ‡∏° PT"
    )


# ===== ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå =====
@app.route("/", methods=["GET"])
def home():
    return "OK", 200

# ===== LINE CALLBACK =====
@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature")
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)

    return "OK"

# ===== ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° =====
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_text = (event.message.text or "").strip()

    # --- ‡∏ó‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á AI ---
    if user_text == "AI":
        reply_text = (
            "üîä ‡∏ó‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á AI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\n"
            "‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢:\n"
            f"{TTS_LINK}"
        )

        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=reply_text)
        )
        return

    # --- ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡∏±‡∏ö‡πÑ‡∏ü ---
    if user_text == "‡∏î‡∏±‡∏ö‡πÑ‡∏ü":
        today = thai_date(datetime.now())
        reply_text = build_outage_template(today)

        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=reply_text)
        )
        return

    # --- ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö ---
    return


if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    app.run(host="0.0.0.0", port=port)

